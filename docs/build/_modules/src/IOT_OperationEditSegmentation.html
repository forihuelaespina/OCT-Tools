
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>src.IOT_OperationEditSegmentation &#8212; OCT-Tools 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OCT-Tools 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for src.IOT_OperationEditSegmentation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-*- coding: utf-8 -*-</span>

<span class="sd">File: IOT_OperationEditSegmentation.py</span>

<span class="sd">Class IOT_OperationEditSegmentation</span>

<span class="sd">Operation EditSegmentation</span>



<span class="sd">:Log:</span>

<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">| Date        | Author | Description                                          |</span>
<span class="sd">+=============+========+======================================================+</span>
<span class="sd">| 5-Aug-2018  | FOE    | - Isolated minimal solution.                         |</span>
<span class="sd">|             |        | - Encapsulated in class.                             |</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">| 22-Aug-2018 | FOE    | - Class name rebranded to capital &quot;O&quot; in operation   |</span>
<span class="sd">|             |        | - Improved verbosity; now using class name           |</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">| 26-Aug-2018 | FOE    | - Dummy segmentation now takes into account          |</span>
<span class="sd">|             |        |   IOT_RetinalLayers                                  |</span>
<span class="sd">|             |        | - Added constant for background                      |</span>
<span class="sd">|             |        | - Incorporated the initial functionality; ROISelect, |</span>
<span class="sd">|             |        |   ROIDeselect, ROIDelete, ROIRelabel                 |</span>
<span class="sd">|             |        | - Debugged getROIPixels; it now correctly parcellates|</span>
<span class="sd">|             |        |   background connected components                    |</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">| 23-Sep-2018 | FOE    | - Updated comments and added Sphinx documentation to |</span>
<span class="sd">|             |        |   the class.                                         |</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">| 15-Nov-2018 | FOE    | - Dummy segmentation now results in a full           |</span>
<span class="sd">|             |        |   segmentation and returns an IOT_OCTscanSegmentation|</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>
<span class="sd">|  1-Dec-2018 | FOE    | - Adapted to IOT_Operation becoming abstract and new |</span>
<span class="sd">|             |        |   capabilities. Added method .execute, integration of|</span>
<span class="sd">|             |        |   operands, given operation name, deprecated method  |</span>
<span class="sd">|             |        |   initEditSegmentation.                              |</span>
<span class="sd">|             |        | - Updated attributes activeROI and activeCOI to      |</span>
<span class="sd">|             |        |   properties.                                        |</span>
<span class="sd">|             |        | - ROISelect method now searches for a labelled ROI   |</span>
<span class="sd">|             |        |   within a neighobourhood.                           |</span>
<span class="sd">+-------------+--------+------------------------------------------------------+</span>

<span class="sd">.. seealso:: None</span>
<span class="sd">.. note:: None</span>
<span class="sd">.. todo:: None</span>

<span class="sd">    </span>
<span class="sd">.. sectionauthor:: Felipe Orihuela-Espina &lt;f.orihuela-espina@inaoep.mx&gt;</span>
<span class="sd">.. codeauthor:: Arlem Aleida Castillo Avila &lt;acastillo@inaoep.mx&gt;</span>
<span class="sd">.. codeauthor:: Felipe Orihuela-Espina &lt;f.orihuela-espina@inaoep.mx&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">## Import</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">deprecated</span> <span class="k">import</span> <span class="n">deprecated</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from skimage import feature, color</span>
<span class="c1">#import cv2 #That&#39;s OpenCV</span>
<span class="c1">#import segmentationUtils</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="k">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">morphology</span>

<span class="kn">from</span> <span class="nn">IOT_Operation</span> <span class="k">import</span> <span class="n">IOT_Operation</span>
<span class="kn">from</span> <span class="nn">IOT_OCTscan</span> <span class="k">import</span> <span class="n">IOT_OCTscan</span>
<span class="kn">from</span> <span class="nn">IOT_OCTscanSegmentation</span> <span class="k">import</span> <span class="n">IOT_OCTscanSegmentation</span>
<span class="kn">from</span> <span class="nn">IOT_RetinalLayers</span> <span class="k">import</span> <span class="n">IOT_RetinalLayers</span>


<span class="c1">## Class definition</span>
<div class="viewcode-block" id="IOT_OperationEditSegmentation"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation">[docs]</a><span class="k">class</span> <span class="nc">IOT_OperationEditSegmentation</span><span class="p">(</span><span class="n">IOT_Operation</span><span class="p">):</span>
    <span class="c1">#Sphinx documentation</span>
    <span class="sd">&quot;&quot;&quot;Operation EditSegmentation</span>
<span class="sd">    </span>
<span class="sd">    This class permits manual manipulation of a segmentation of retinal layers</span>
<span class="sd">    from an OCT image. The class provides its functionality by manipulating</span>
<span class="sd">    local regions of interest (ROI) and or Classes of interest (COI) in the</span>
<span class="sd">    segmentation.</span>
<span class="sd">    A ROI is just a connected set of pixels with the same label. A COI is the</span>
<span class="sd">    set of all ROIs sharing the same label.</span>
<span class="sd">    </span>
<span class="sd">    The class provides a set of basic operations for selecting and</span>
<span class="sd">    then maniplating some ROI or COI in a segmentation; including:</span>
<span class="sd">    </span>
<span class="sd">    * Delete</span>
<span class="sd">    * Change label</span>
<span class="sd">    </span>
<span class="sd">    Whether working with ROI or COI always select the active COI or ROI</span>
<span class="sd">    before applying an operation.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    .. seealso:: None</span>
<span class="sd">    .. note:: Operand is an class:`IOT_OCTscanSegmentation`, but a reference</span>
<span class="sd">        image can be hold as the class:`IOT_OCTscanSegmentation` attribute</span>
<span class="sd">        :py:attr:`scan`</span>
<span class="sd">    .. todo:: None</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Private class attributes shared by all instances</span>
    <span class="n">BACKGROUND</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1">#Class constructor</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The class constructor.</span>

<span class="sd">        The class constructor.</span>

<span class="sd">        tmp = IOT_OperationEditSegmentation() - Creates an empty EditSegmentation operation</span>
<span class="sd">        </span>

<span class="sd">        :param img: The scan image</span>
<span class="sd">        :type img: numpy.ndarray</span>
<span class="sd">        :param type: The scan type (&#39;A&#39; -default-, &#39;B&#39; or &#39;C&#39;)</span>
<span class="sd">        :type type: char</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Call superclass constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1">#Set the operation name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;EditSegmentation&quot;</span>

        <span class="c1">#Initialize private attributes unique to this instance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Currently active ROI.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span> <span class="c1">#Currently active COI. </span>
    
        <span class="k">return</span>
        
        
        
    <span class="c1">#Properties getters/setters</span>
    <span class="c1">#</span>
    <span class="c1"># Remember: Sphinx ignores docstrings on property setters so all</span>
    <span class="c1">#documentation for a property must be on the @property method</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">activeROI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#activeROI getter</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently active ROI.</span>
<span class="sd">        </span>
<span class="sd">        The ROI is identified by a position</span>
<span class="sd">        tuple (x,y[,z]) indicating any pixel ROI. The ROI itself is</span>
<span class="sd">        all the connected of the component to this pixel. The class</span>
<span class="sd">        of the ROI corresponds the label at (x,y[,z])</span>
<span class="sd">        </span>
<span class="sd">        :getter: Gets the active ROI</span>
<span class="sd">        :setter: Sets the active ROI to (x,y[,z]).</span>
<span class="sd">        :type: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__activeROI</span>

    <span class="nd">@activeROI</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">activeROI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newROI</span><span class="p">):</span> <span class="c1">#activeROI setter</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1">#It might be more correct to also check for the internal type to be</span>
            <span class="c1">#scalars.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activeROI</span> <span class="o">=</span> <span class="n">newROI</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1">#Unexpected case. Return warning</span>
            <span class="n">warnMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:activeROI: List [x,y[,z]] will be recasted to tuple (x,y[,z]).&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">,</span><span class="ne">SyntaxWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__activeROI</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newROI</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span> <span class="c1">#Unexpected case. Return warning</span>
            <span class="n">warnMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:activeROI: Value must be a tuple (x,y[,z]).&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">,</span><span class="ne">SyntaxWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">activeCOI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#activeCOI getter</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently active COI.</span>
<span class="sd">        </span>
<span class="sd">        The COI is identified by its class ID.</span>
<span class="sd">        </span>
<span class="sd">        :getter: Gets the active COI</span>
<span class="sd">        :setter: Sets the active COI</span>
<span class="sd">        :type: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__activeCOI</span>

    <span class="nd">@activeCOI</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">activeCOI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newCOI</span><span class="p">):</span> <span class="c1">#activeCOI setter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__activeCOI</span> <span class="o">=</span> <span class="n">newCOI</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="c1">#Private methods</span>



    <span class="k">def</span> <span class="nf">_generateDummySegmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define a dummy segmentation.</span>
<span class="sd">        </span>
<span class="sd">        Generates a dummy segmentation.</span>
<span class="sd">        </span>
<span class="sd">        :returns: An OCT scan segmentation</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Define a dummy segmentation</span>
        <span class="c1">#print(self.getClassName(),&quot;: _generateDummySegmentation: Generating dummy segmentation.&quot;)</span>
        <span class="n">r</span><span class="o">=</span> <span class="n">IOT_RetinalLayers</span><span class="p">()</span>
        <span class="n">nLayers</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getNumLayers</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getAllLayersIndexes</span><span class="p">()</span>
        
        <span class="c1">#Generate a dummy refImage of the appropiate size</span>
        <span class="n">refImage</span> <span class="o">=</span> <span class="n">IOT_OCTscan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">));</span>
        
        
        <span class="c1">#Define a default output -simple nLayers lines (one per layer)</span>
        <span class="n">imageSegmented</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span> <span class="p">)</span>
        <span class="n">stepHeight</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="p">(</span><span class="n">nLayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="mf">0.3</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="p">(</span><span class="n">nLayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nLayers</span><span class="p">):</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">ii</span><span class="o">*</span><span class="n">stepHeight</span>
            <span class="c1">#imageSegmented[kk-2:kk+2,:] = tmp[ii-1] #5 pixels thick</span>
                <span class="c1">#Watch out! Lines thinner than 3-5 pixels thick may not</span>
                <span class="c1">#be visible when rendered on the screen (depending on</span>
                <span class="c1">#the resolution).</span>
            <span class="n">imageSegmented</span><span class="p">[</span><span class="n">kk</span><span class="p">:</span><span class="n">kk</span><span class="o">+</span><span class="n">stepHeight</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#Segment the full</span>
                <span class="c1">#band until the next layer.</span>
            <span class="c1">#print(kk, ii)</span>
        
        <span class="c1">#Encapsulate</span>
        <span class="n">dummySegmentation</span> <span class="o">=</span> <span class="n">IOT_OCTscanSegmentation</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
        <span class="n">dummySegmentation</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imageSegmented</span> 
        
        <span class="k">return</span> <span class="n">dummySegmentation</span>


    

    <span class="c1">#Public methods </span>
<div class="viewcode-block" id="IOT_OperationEditSegmentation.execute"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes the operation on the :py:attr:`operands`.</span>
<span class="sd">        </span>
<span class="sd">        Executes the operation on the :py:attr:`operands` and stores the </span>
<span class="sd">        outcome in :py:attr:`result`. Preload operands using</span>
<span class="sd">        :func:`IOT:Operation.addOperand()`.</span>
<span class="sd">        </span>
<span class="sd">        :param editType: A string indicating the type of edition</span>
<span class="sd">        :type editType: String</span>
<span class="sd">        :returns: Result of executing the operation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscan`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(self._getClasName(),&quot;: flattening: Starting flattening&quot;)</span>
        
        <span class="c1">#Define a default result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Start by copying operand into result</span>
        
        <span class="c1">#Ensure the operand has been set.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arity</span><span class="p">()</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">warnMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:execute: Operand not set.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">,</span><span class="ne">SyntaxWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
        
        <span class="c1"># imgin = self.operands[0]</span>
        <span class="c1"># if isinstance(imgin,(IOT_OCTscanSegmentation,)):</span>
        <span class="c1">#     imgin=imgin.data</span>

        <span class="c1">#Indirect call to the operation</span>
        <span class="c1">#See: https://stackoverflow.com/questions/3061/calling-a-function-of-a-module-by-using-its-name-a-string    </span>
        <span class="n">theOperationName</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">kwargs</span><span class="p">]</span>
        <span class="n">theOp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theOperationName</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imSegmented</span> <span class="o">=</span> <span class="n">theOp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imSegmented</span> <span class="o">=</span> <span class="n">theOp</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

            
        <span class="c1">#if isinstance(imgin,(IOT_OCTscan,)):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">imgin</span><span class="p">)</span> <span class="ow">is</span> <span class="n">IOT_OCTscan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">IOT_OCTscanSegmentation</span><span class="p">(</span><span class="n">imgin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">=</span><span class="n">IOT_OCTscanSegmentation</span><span class="p">(</span><span class="n">IOT_OCTscan</span><span class="p">(</span><span class="n">imgin</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imSegmented</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>   </div>
    
    <span class="c1"># See: https://pypi.org/project/pynput/</span>
<div class="viewcode-block" id="IOT_OperationEditSegmentation.initEditSegmentation"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.initEditSegmentation">[docs]</a>    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Deprecated. Use method addOperand() and add reference image as scan property of class:`IOT_OCTscanSegmentation`.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initEditSegmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refImage</span><span class="p">,</span><span class="n">imageSegmented</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize segmentation for editing from reference :class:`IOT_OCTscan`.</span>
<span class="sd">        </span>
<span class="sd">        :param refImage: A reference OCT scan</span>
<span class="sd">        :type refImage: :class:`IOT_OCTscan`</span>
<span class="sd">        :param imageSegmented: The operand. A segmentation over parameter refImage.</span>
<span class="sd">        :type imageSegmented: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        :returns: An initialized edit segmentation operation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#if not isinstance(refImage,(IOT_OCTscan,)):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">IOT_OCTscan</span><span class="p">:</span>
            <span class="c1">#Encapsulate</span>
            <span class="n">refImage</span><span class="o">=</span><span class="n">IOT_OCTscan</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
            
        <span class="c1">#Operand is the image to be segmented</span>

        <span class="c1">#print(&quot;OCT-Tools: IOT_operationSegmentation: Starting manual editing of retinal layer segmentation&quot;)</span>
        <span class="n">tmp</span><span class="o">=</span><span class="n">IOT_OCTscanSegmentation</span><span class="p">(</span><span class="n">refImage</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1">#Second parameter is a seed segmentation. If none provided, generate a dummy one on the fly.</span>
        <span class="k">if</span> <span class="n">imageSegmented</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#print(&quot;OCT-Tools: IOT_operationSegmentation: Segmentation not found.&quot;)</span>
            <span class="n">tmpImgSize</span> <span class="o">=</span> <span class="n">refImage</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">imageSegmented</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateDummySegmentation</span><span class="p">(</span><span class="n">tmpImgSize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tmpImgSize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">imageSegmented</span><span class="p">)</span> <span class="ow">is</span> <span class="n">IOT_OCTscanSegmentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">imageSegmented</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnMsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;:initEditSegmentation: Unexpected type for imageSegmented.&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">,</span><span class="ne">SyntaxWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imageSegmented</span>    </div>


    <span class="c1">#Manipulation of ROI</span>
<div class="viewcode-block" id="IOT_OperationEditSegmentation.getROIPixels"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.getROIPixels">[docs]</a>    <span class="k">def</span> <span class="nf">getROIPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the indexes of all the pixels in the connected component of the current ROI.</span>

<span class="sd">        :returns: Indexes of connected pixels in the ROI</span>
<span class="sd">        :rtype: np.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmpOperand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Access operand</span>
        
        <span class="c1">#skimage.morphology.label does not split BG regions. So start</span>
        <span class="c1">#checking whether the active region is in the background</span>
        
        <span class="n">imSegmented</span> <span class="o">=</span> <span class="n">tmpOperand</span>
        <span class="n">isBG</span> <span class="o">=</span> <span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span><span class="p">]</span> <span class="o">==</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
        <span class="k">if</span> <span class="n">isBG</span><span class="p">:</span>
            <span class="c1">#Trick skimage.morphology.label into believing the background is NOT the backgrond</span>
            <span class="n">tmpDummy</span> <span class="o">=</span> <span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="o">==</span><span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
            <span class="n">imSegmented</span> <span class="o">=</span> <span class="n">tmpDummy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="c1">#Now change from boolean to integers</span>

        
        <span class="c1">#Get connected components (background is not counted)</span>
        <span class="n">tmpConnectedComponents</span><span class="p">,</span><span class="n">numComponents</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">imSegmented</span><span class="p">,</span>
                    <span class="n">neighbors</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">background</span><span class="o">=</span><span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span><span class="p">,</span>
                    <span class="n">return_num</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#Find component index associated to active ROI</span>
        <span class="n">cIdx</span><span class="o">=</span><span class="n">tmpConnectedComponents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span><span class="p">]</span>
        <span class="c1">#Retrieve the indexes of pixels in the connected component to the active ROI</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tmpConnectedComponents</span> <span class="o">==</span> <span class="n">cIdx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span></div>

<div class="viewcode-block" id="IOT_OperationEditSegmentation.getCOIPixels"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.getCOIPixels">[docs]</a>    <span class="k">def</span> <span class="nf">getCOIPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the indexes of all the pixels of the current COI</span>

<span class="sd">        :returns: Indexes of pixels in the COI</span>
<span class="sd">        :rtype: np.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmpOperand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Access operand</span>
        
        <span class="n">idx</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">coi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Check active COI</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">coi</span><span class="o">==</span><span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">nd</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">coi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span></div>

    
<div class="viewcode-block" id="IOT_OperationEditSegmentation.getROILabel"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.getROILabel">[docs]</a>    <span class="k">def</span> <span class="nf">getROILabel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the class or label of the current ROI.</span>
<span class="sd">        </span>
<span class="sd">        :returns: The class or label of the current ROI</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmpOperand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Access operand</span>
        <span class="k">return</span> <span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="IOT_OperationEditSegmentation.ROISelect"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.ROISelect">[docs]</a>    <span class="k">def</span> <span class="nf">ROISelect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">radius</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select the closest labelled ROI within some radius (in pixels) of pos.</span>
<span class="sd">        </span>
<span class="sd">        Select the closest labelled ROI within some radius (in pixels) of pos</span>
<span class="sd">        or the BACKGROUND if no labelled region is found.</span>
<span class="sd">        </span>
<span class="sd">        If pos correspond to a labelled region, then it becomes the </span>
<span class="sd">        py:attr:`activeROI`, and True is returned.</span>
<span class="sd">        </span>
<span class="sd">        If pos is in the BACKGROUND, and it is at the same distance</span>
<span class="sd">        of more than one labelled regions, then the selected ROI is pick</span>
<span class="sd">        at random (actually it selects the first found from the top left)</span>
<span class="sd">        and True is returned.</span>
<span class="sd">        </span>
<span class="sd">        If pos is in the BACKGROUND, and no labelled region is found in the</span>
<span class="sd">        neighbourhood, then pos becomes the new py:attr:`activeROI` and</span>
<span class="sd">        False is returned.</span>
<span class="sd">        </span>
<span class="sd">        ..note: To select a specific ROI regardless of its class ID (e.g.</span>
<span class="sd">            enforce selection of a BACKGROUND pixel), simply assign some</span>
<span class="sd">            value to property py:attr:`activeROI`</span>
<span class="sd">        </span>
<span class="sd">        :param pos: A pixel/voxel of the ROI; (x,y) or (x,y,z)</span>
<span class="sd">        :type pos: tuple or list</span>
<span class="sd">        :param radius: Radius in pixels. Default value is 10 pixels</span>
<span class="sd">        :type radius: uint</span>
<span class="sd">        :returns: True if a labelled ROI has been found or False otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmpOperand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Access operand</span>
                        
        <span class="c1">#print(self.getClassName(),&quot;:ROISelect: Selecting ROI connected to pixel &quot;,pos)</span>
        <span class="n">flagFound</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#Check whether there is some region in the area</span>
        <span class="k">if</span> <span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span><span class="p">:</span>
            <span class="c1">#pos is in BACKGROUND. Look for nearby labelled regions</span>
            <span class="n">r</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">radius</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flagFound</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1">#Extract squared subimage around pos (without exceeding borders).</span>
                <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ixgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">zmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">zmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ixgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span><span class="n">zmax</span><span class="p">))</span>
                <span class="n">tmpRegion</span> <span class="o">=</span> <span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ixgrid</span><span class="p">]</span>
                <span class="n">labelledRegions</span> <span class="o">=</span> <span class="n">tmpRegion</span> <span class="o">!=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">labelledRegions</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="c1">#Update pos to nearest labelled region</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labelledRegions</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#Indexes pairs</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#Choose the first index pair</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#Choose the first index pair</span>
                    <span class="n">flagFound</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#pos is in a labelled region</span>
            <span class="n">flagFound</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">return</span> <span class="n">flagFound</span></div>

<div class="viewcode-block" id="IOT_OperationEditSegmentation.ROIChangeLabel"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.ROIChangeLabel">[docs]</a>    <span class="k">def</span> <span class="nf">ROIChangeLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newClassID</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates the label of the current active ROI</span>
<span class="sd">        </span>
<span class="sd">        Updates the label of the current active ROI or the selected ROI (if</span>
<span class="sd">        argument pos is provided).</span>
<span class="sd">        </span>
<span class="sd">        If provided, pos becomes the new py:attr:`activeROI`</span>
<span class="sd">        </span>
<span class="sd">        ..note: This removes the current active ROI from the segmentation, </span>
<span class="sd">            since no pixel with the current label will remain in</span>
<span class="sd">            the segmentation. If you only want to affect some ROI, then</span>
<span class="sd">            use ROIChangeLabel instead.</span>

<span class="sd">        :param newClassID: A reference OCT scan</span>
<span class="sd">        :type newClassID: :class:`IOT_OCTscan`</span>
<span class="sd">        :param pos: A pixel/voxel of the ROI; (x,y) or (x,y,z). Default None.</span>
<span class="sd">        :type pos: tuple or list</span>
<span class="sd">        :returns: The modified segmentation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Start by copying operand into result</span>
        
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="o">=</span> <span class="n">pos</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#This may occur if trying to call the</span>
                                   <span class="c1">#operation right after creating this</span>
                                   <span class="c1">#object instance (when activeROI is None),</span>
                                   <span class="c1">#but still calling to execute operation</span>
                                   <span class="c1">#without parameters</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:ROIChangeLabel: No ROI selected. Passing...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:ROIChangeLabel: activeROI: &quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span><span class="p">,</span><span class="s2">&quot; with class &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getROILabel</span><span class="p">(),</span><span class="s2">&quot;; newClassID:&quot;</span><span class="p">,</span><span class="n">newClassID</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getROIPixels</span><span class="p">()</span>
            <span class="c1">#print(idx)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newClassID</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span></div>


        
<div class="viewcode-block" id="IOT_OperationEditSegmentation.ROIDelete"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.ROIDelete">[docs]</a>    <span class="k">def</span> <span class="nf">ROIDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the current active ROI and sets it to BACKGROUND</span>
<span class="sd">       </span>
<span class="sd">        Sets the label of the current active ROI or the selected ROI (if</span>
<span class="sd">        argument pos is provided) to BACKGROUND.</span>
<span class="sd">        </span>
<span class="sd">        If provided, pos becomes the new py:attr:`activeROI`</span>

<span class="sd">        :param pos: A pixel/voxel of the ROI; (x,y) or (x,y,z). Default None.</span>
<span class="sd">        :type pos: tuple or list</span>
<span class="sd">        :returns: The modified segmentation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Start by copying operand into result</span>
        
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="o">=</span> <span class="n">pos</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#This may occur if trying to call the</span>
                                   <span class="c1">#operation right after creating this</span>
                                   <span class="c1">#object instance (when activeROI is None),</span>
                                   <span class="c1">#but still calling to execute operation</span>
                                   <span class="c1">#without parameters</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:ROIDelete: No ROI selected. Passing...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:ROIDelete: Deleting activeROI: &quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">activeROI</span><span class="p">,</span><span class="s2">&quot; with class &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getROILabel</span><span class="p">())</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getROIPixels</span><span class="p">()</span>
            <span class="c1">#print(idx)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span></div>
        



    <span class="c1">#Manipulation of COI</span>
<div class="viewcode-block" id="IOT_OperationEditSegmentation.COISelect"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.COISelect">[docs]</a>    <span class="k">def</span> <span class="nf">COISelect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">classID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select a COI by its label.</span>
<span class="sd">        </span>
<span class="sd">        Select a COI by its label. If the classID is not found in the</span>
<span class="sd">        segmentation, then the BACKGROUND is selected.</span>
<span class="sd">                </span>
<span class="sd">        :param classID: A class ID.</span>
<span class="sd">        :type classID: int</span>
<span class="sd">        :returns: True if the class ID is present in the segmentation or False</span>
<span class="sd">            otherwise (BACKGROUND selected).</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:COISelect: Selecting layer &quot;</span><span class="p">,</span> <span class="n">classID</span><span class="p">)</span>
        
        <span class="n">tmpOperand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Access operand</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tmpOperand</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">classID</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span> <span class="o">=</span> <span class="n">classID</span>
        
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span></div>
        
<div class="viewcode-block" id="IOT_OperationEditSegmentation.COIDelete"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.COIDelete">[docs]</a>    <span class="k">def</span> <span class="nf">COIDelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classID</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes the COI identified by classID.</span>
<span class="sd">        </span>
<span class="sd">        Deletes the COI identified by classID. Sets the COI to BACKGROUND</span>
<span class="sd">        If classID is None, then it works over the current active COI.</span>
<span class="sd">                </span>
<span class="sd">        :param classID: A class ID. Default None</span>
<span class="sd">        :type classID: int</span>
<span class="sd">        :returns: The modified segmentation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Start by copying operand into result</span>
        
        <span class="k">if</span> <span class="n">classID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Operate over current active COI</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">)</span>
                <span class="c1">#WATCH OUT!</span>
                <span class="c1">#Distinctly from MATLAB, here I do not get a &quot;list&quot; of locations</span>
                <span class="c1">#indexing the array form 1 to numel(self.result). Instead,</span>
                <span class="c1">#a &quot;coupled&quot; pair of lists for the xIdx and yIdx are obtained.</span>
                <span class="c1">#</span>
                <span class="c1">#So to check whether it is &quot;empty&quot; I cannot do:</span>
                <span class="c1">#   len(idx)</span>
                <span class="c1">#...as this is equal to 2.</span>
                <span class="c1">#I must question &quot;along a single dimension; e.g. len(idx[0])</span>
                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:COIDelete: Layer &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">,</span><span class="s2">&quot; not found. Skipping.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:COIDelete: Layer &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">,</span><span class="s2">&quot; found. Deleting layer &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span> <span class="o">=</span> <span class="n">IOT_OperationEditSegmentation</span><span class="o">.</span><span class="n">BACKGROUND</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COISelect</span><span class="p">(</span><span class="n">classID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COIDelete</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span></div>
        
<div class="viewcode-block" id="IOT_OperationEditSegmentation.COIChangeLabel"><a class="viewcode-back" href="../../src.IOT_OperationEditSegmentation.html#src.IOT_OperationEditSegmentation.IOT_OperationEditSegmentation.COIChangeLabel">[docs]</a>    <span class="k">def</span> <span class="nf">COIChangeLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newClassID</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates the label of the current active COI</span>
<span class="sd">        </span>
<span class="sd">        Updates the label of the current active COI or the selected COI (if</span>
<span class="sd">        argument coi is provided).</span>
<span class="sd">        </span>
<span class="sd">        The newClassID becomes the new updated COI.</span>
<span class="sd">        </span>
<span class="sd">        ..note: This removes the current active COI from the segmentation, </span>
<span class="sd">            since no pixel with the current label will remain in</span>
<span class="sd">            the segmentation. If you only want to affect some ROI, then use</span>
<span class="sd">            func:`ROIChangeLabel` instead</span>
<span class="sd">                </span>
<span class="sd">        :param newClassID: The new class ID.</span>
<span class="sd">        :type newClassID: int</span>
<span class="sd">        :param coi: The class ID to be changed. Default None</span>
<span class="sd">        :type coi: int</span>
<span class="sd">        :returns: The modified segmentation.</span>
<span class="sd">        :rtype: :class:`IOT_OCTscanSegmentation`</span>
<span class="sd">        &quot;&quot;&quot;</span>    
    
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">#Start by copying operand into result</span>
        
        <span class="k">if</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">COISelect</span><span class="p">(</span><span class="n">coi</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getClassName</span><span class="p">(),</span><span class="s2">&quot;:COIChangeLabel: activeCOI:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">,</span><span class="s2">&quot;; newClassID:&quot;</span><span class="p">,</span><span class="n">newClassID</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newClassID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeCOI</span> <span class="o">=</span> <span class="n">newClassID</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span></div></div>
        
        
        
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">OCT-Tools 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-8, Felipe Orihuela-Espina.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.
    </div>
  </body>
</html>